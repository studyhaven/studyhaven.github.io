rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── User data ──
    // Each user can only read/write their own documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Tasks
      match /tasks/{taskId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Activity logs
      match /activityLogs/{logId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Calorie logs
      match /calorieLogs/{logId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Settings (calorie goal, user profile/timezone, timer session, etc.)
      // Includes: settings/tracker (calorieGoal), settings/profile (timezone),
      //           settings/timerSession (endsAt, status, repeat)
      match /settings/{settingId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ── FCM Tokens ──
      // Users can write their own tokens (from the browser)
      // The server-side admin SDK bypasses these rules entirely (uses service account)
      match /fcmTokens/{tokenId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ── AI Chat History ──
      // Haven conversation history, keyed by user — one doc per message pair
      match /aiChat/{messageId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ── Timer History ──
      // Previous timer session completions (up to 10 kept)
      match /timerHistory/{sessionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
